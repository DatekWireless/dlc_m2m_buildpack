#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

export_env_dir() {
  env_dir=$1
  acceptlist_regex=${2:-''}
  denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

APP_DIR=$1
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo BUILD_DIR=$1
echo CACHE_DIR=$2
echo ENV_DIR=$3


echo "-----> Found DatekLightControl app"
pwd
ls -l

echo "tmp"
ls -l /tmp/
echo "tmp/build_*"
ls -l /tmp/build_*
echo "app/tmp/buildpacks"
ls -l /app/tmp/buildpacks

echo Find java
find / -name java

echo Find maven
find / -name mvn

export PATH=/app/tmp/cache/.m2/wrapper/dists/apache-maven-3.6.3-bin/1iopthnavndlasol9gbrbg6bf2/apache-maven-3.6.3/bin:$PATH

env | sort

echo "${HOME}/.m2/settings.xml"
cat ${HOME}/.m2/settings.xml
cp -a settings.xml ${HOME}/.m2/settings.xml
cat ${HOME}/.m2/settings.xml

cd "$1" || exit 1
pwd
ls -la
echo "Starting release script" | indent
cd LightControl || exit 1
./release.rb --skip-tests
