#!/bin/sh

indent() {
  sed -u 's/^/       /'
}

export_env_dir() {
  env_dir=$1
  acceptlist_regex=${2:-''}
  denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

APP_DIR=$1
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo BUILD_DIR=$1
echo CACHE_DIR=$2
echo ENV_DIR=$3

set -e

export_env_dir $ENV_DIR

echo "-----> Found DatekLightControl app"
pwd
ls -l

echo "tmp"
ls -l /tmp/
echo "tmp/build_*"
ls -l /tmp/build_*
echo "app/tmp/buildpacks"
ls -l /app/tmp/buildpacks

set +e
echo Find java
find / -name java
set -e

echo "Cache:"
ls -l "${CACHE_DIR}"

if [ -d "${CACHE_DIR}/OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10" ] ; then
  echo "Java found"
else
  cd "${CACHE_DIR}" || exit 1
  echo "Downloading Java"
  curl -L -o OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10.tar.gz https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11.0.7%2B10/OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10.tar.gz
  ls -l
  tar xzf OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10.tar.gz
  rm -f OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10.tar.gz
  cd - || exit 1
fi

if [ -d "${CACHE_DIR}/apache-maven-3.6.3" ] ; then
  echo "Maven found"
else
  cd "${CACHE_DIR}" || exit 1
  echo "Downloading Maven"
  curl -L -o apache-maven-3.6.3-bin.tar.gz  https://apache.uib.no/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
  ls -l
  tar xzf apache-maven-3.6.3-bin.tar.gz
  rm -f apache-maven-3.6.3-bin.tar.gz
  cd - || exit 1
fi
export PATH=${CACHE_DIR}/OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10/bin:$PATH

set +e
echo Find maven
find / -name mvn
set -e

export PATH=/app/tmp/cache/.m2/wrapper/dists/apache-maven-3.6.3-bin/1iopthnavndlasol9gbrbg6bf2/apache-maven-3.6.3/bin:$PATH
export PATH=${CACHE_DIR}/apache-maven-3.6.3/bin:$PATH

env | sort

echo "${HOME}/.m2/settings.xml"
cat ${HOME}/.m2/settings.xml
mkdir -p ${HOME}/.m2
cp -a settings.xml ${HOME}/.m2/settings.xml
cat ${HOME}/.m2/settings.xml

cd "$1" || exit 1
pwd
ls -la
echo "Starting release script" | indent
cd LightControl || exit 1
./release.rb --skip-tests
